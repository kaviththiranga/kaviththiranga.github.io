<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <title>API Docs - ballerina/websub</title>
    <script src="../html-template-resources/jquery.min.js"></script>
    <link rel="stylesheet" href="../html-template-resources/semantic.min.css">
    <link rel="stylesheet" href="../html-template-resources/styles/css/styles.css">
    <link rel="stylesheet" href="../html-template-resources/styles/css/font.css">
    <script src="../html-template-resources/semantic.min.js"></script>
    <script src="../vs/monaco.js"></script>
</head>


<body>
    <div class="navi-wrapper">
        <div class="navi-wrapper-content">
            <a href="../index.html">
    <img class="logo" src="../html-template-resources/images/ballerina-logo.png">
</a>
<div class="version">v0.991.0</div>

            <div class="primary-list module">
    <a href="../websub/index.html">
        <h3>websub</h3>
    </a>
    <ul>
        
        
        
        
        
        
        
        
        
    </ul>
    <div class="ui divider"></div>
</div>

            <div class="primary-list module-list">
    <h3>All Modules</h3>
    <ul>
        
        <li>
            <a href="../artemis/index.html">artemis</a>
        </li>
        
        <li>
            <a href="../auth/index.html">auth</a>
        </li>
        
        <li>
            <a href="../bir/index.html">bir</a>
        </li>
        
        <li>
            <a href="../cache/index.html">cache</a>
        </li>
        
        <li>
            <a href="../config/index.html">config</a>
        </li>
        
        <li>
            <a href="../crypto/index.html">crypto</a>
        </li>
        
        <li>
            <a href="../encoding/index.html">encoding</a>
        </li>
        
        <li>
            <a href="../file/index.html">file</a>
        </li>
        
        <li>
            <a href="../filepath/index.html">filepath</a>
        </li>
        
        <li>
            <a href="../grpc/index.html">grpc</a>
        </li>
        
        <li>
            <a href="../h2/index.html">h2</a>
        </li>
        
        <li>
            <a href="../http/index.html">http</a>
        </li>
        
        <li>
            <a href="../internal/index.html">internal</a>
        </li>
        
        <li>
            <a href="../io/index.html">io</a>
        </li>
        
        <li>
            <a href="../jms/index.html">jms</a>
        </li>
        
        <li>
            <a href="../jvm/index.html">jvm</a>
        </li>
        
        <li>
            <a href="../jwt/index.html">jwt</a>
        </li>
        
        <li>
            <a href="../ldap/index.html">ldap</a>
        </li>
        
        <li>
            <a href="../llvm/index.html">llvm</a>
        </li>
        
        <li>
            <a href="../log/index.html">log</a>
        </li>
        
        <li>
            <a href="../math/index.html">math</a>
        </li>
        
        <li>
            <a href="../mime/index.html">mime</a>
        </li>
        
        <li>
            <a href="../mysql/index.html">mysql</a>
        </li>
        
        <li>
            <a href="../nats/index.html">nats</a>
        </li>
        
        <li>
            <a href="../oauth2/index.html">oauth2</a>
        </li>
        
        <li>
            <a href="../observe/index.html">observe</a>
        </li>
        
        <li>
            <a href="../openapi/index.html">openapi</a>
        </li>
        
        <li>
            <a href="../privacy/index.html">privacy</a>
        </li>
        
        <li>
            <a href="../rabbitmq/index.html">rabbitmq</a>
        </li>
        
        <li>
            <a href="../reflect/index.html">reflect</a>
        </li>
        
        <li>
            <a href="../runtime/index.html">runtime</a>
        </li>
        
        <li>
            <a href="../socket/index.html">socket</a>
        </li>
        
        <li>
            <a href="../sql/index.html">sql</a>
        </li>
        
        <li>
            <a href="../streams/index.html">streams</a>
        </li>
        
        <li>
            <a href="../system/index.html">system</a>
        </li>
        
        <li>
            <a href="../task/index.html">task</a>
        </li>
        
        <li>
            <a href="../test/index.html">test</a>
        </li>
        
        <li>
            <a href="../time/index.html">time</a>
        </li>
        
        <li>
            <a href="../transactions/index.html">transactions</a>
        </li>
        
        <li>
            <a href="../utils/index.html">utils</a>
        </li>
        
        <li>
            <a href="../websub/index.html">websub</a>
        </li>
        
    </ul>
    <div class="ui divider"></div>
</div>
        </div>
    </div>

    <div class="ui vertical sidebar menu">
        <div class="navi-wrapper-sidebar">
            <div class="navi-wrapper-content">
                <a href="../index.html">
    <img class="logo" src="../html-template-resources/images/ballerina-logo.png">
</a>
<div class="version">v0.991.0</div>

                
                <div class="primary-list module">
    <a href="../websub/index.html">
        <h3>websub</h3>
    </a>
    <ul>
        
        
        
        
        
        
        
        
        
    </ul>
    <div class="ui divider"></div>
</div>

                <div class="primary-list module-list">
    <h3>All Modules</h3>
    <ul>
        
        <li>
            <a href="../artemis/index.html">artemis</a>
        </li>
        
        <li>
            <a href="../auth/index.html">auth</a>
        </li>
        
        <li>
            <a href="../bir/index.html">bir</a>
        </li>
        
        <li>
            <a href="../cache/index.html">cache</a>
        </li>
        
        <li>
            <a href="../config/index.html">config</a>
        </li>
        
        <li>
            <a href="../crypto/index.html">crypto</a>
        </li>
        
        <li>
            <a href="../encoding/index.html">encoding</a>
        </li>
        
        <li>
            <a href="../file/index.html">file</a>
        </li>
        
        <li>
            <a href="../filepath/index.html">filepath</a>
        </li>
        
        <li>
            <a href="../grpc/index.html">grpc</a>
        </li>
        
        <li>
            <a href="../h2/index.html">h2</a>
        </li>
        
        <li>
            <a href="../http/index.html">http</a>
        </li>
        
        <li>
            <a href="../internal/index.html">internal</a>
        </li>
        
        <li>
            <a href="../io/index.html">io</a>
        </li>
        
        <li>
            <a href="../jms/index.html">jms</a>
        </li>
        
        <li>
            <a href="../jvm/index.html">jvm</a>
        </li>
        
        <li>
            <a href="../jwt/index.html">jwt</a>
        </li>
        
        <li>
            <a href="../ldap/index.html">ldap</a>
        </li>
        
        <li>
            <a href="../llvm/index.html">llvm</a>
        </li>
        
        <li>
            <a href="../log/index.html">log</a>
        </li>
        
        <li>
            <a href="../math/index.html">math</a>
        </li>
        
        <li>
            <a href="../mime/index.html">mime</a>
        </li>
        
        <li>
            <a href="../mysql/index.html">mysql</a>
        </li>
        
        <li>
            <a href="../nats/index.html">nats</a>
        </li>
        
        <li>
            <a href="../oauth2/index.html">oauth2</a>
        </li>
        
        <li>
            <a href="../observe/index.html">observe</a>
        </li>
        
        <li>
            <a href="../openapi/index.html">openapi</a>
        </li>
        
        <li>
            <a href="../privacy/index.html">privacy</a>
        </li>
        
        <li>
            <a href="../rabbitmq/index.html">rabbitmq</a>
        </li>
        
        <li>
            <a href="../reflect/index.html">reflect</a>
        </li>
        
        <li>
            <a href="../runtime/index.html">runtime</a>
        </li>
        
        <li>
            <a href="../socket/index.html">socket</a>
        </li>
        
        <li>
            <a href="../sql/index.html">sql</a>
        </li>
        
        <li>
            <a href="../streams/index.html">streams</a>
        </li>
        
        <li>
            <a href="../system/index.html">system</a>
        </li>
        
        <li>
            <a href="../task/index.html">task</a>
        </li>
        
        <li>
            <a href="../test/index.html">test</a>
        </li>
        
        <li>
            <a href="../time/index.html">time</a>
        </li>
        
        <li>
            <a href="../transactions/index.html">transactions</a>
        </li>
        
        <li>
            <a href="../utils/index.html">utils</a>
        </li>
        
        <li>
            <a href="../websub/index.html">websub</a>
        </li>
        
    </ul>
    <div class="ui divider"></div>
</div>
            </div>
        </div>
    </div>



    <div class="content-wrapper pusher">
        <div>
    <a class="toc item"> 
        <img src="../html-template-resources/images/menu.svg">
    </a>
</div>
        <div class="main-wrapper module-wrapper">
                <h1>
                    <a class="breadcrumb-home" href="../index.html">
    <img class="breadcrumb-home-icon" src="../html-template-resources/images/home.svg">
</a>
                    Module : <span class="modules">websub</span></h1>
                    <h2>Module overview</h2>
<p>This module contains an implementation of the W3C <a href="https://www.w3.org/TR/websub/"><strong>WebSub</strong></a> recommendation, which facilitates a push-based content delivery/notification mechanism between publishers and subscribers.</p>
<p>This implementation supports introducing all WebSub components: subscribers, publishers, and hubs.</p>
<ul>
<li>Subscriber - A party interested in receiving update notifications for particular topics.</li>
<li>Publisher - A party that advertises topics to which interested parties subscribe in order to receive notifications
on occurrence of events.</li>
<li>Hub - A party that accepts subscription requests from subscribers and delivers content to the subscribers when the topic
is updated by the topic's publisher.</li>
</ul>
<h3>Basic flow with WebSub</h3>
<ol>
<li>
<p>The subscriber discovers from the publisher, the topic it needs to subscribe to and the hub(s) that deliver notifications on updates of the topic.</p>
</li>
<li>
<p>The subscriber sends a subscription request to one or more discovered hub(s) specifying the discovered topic along
with other subscription parameters such as:</p>
<ul>
<li>The callback URL to which content is expected to be delivered.</li>
<li>(Optional) The lease period (in seconds) the subscriber wants the subscription to stay active.</li>
<li>(Optional) A secret to use for <a href="https://www.w3.org/TR/websub/#signing-content">authenticated content distribution</a>.</li>
</ul>
</li>
<li>
<p>The hub sends an intent verification request to the specified callback URL. If the response indicates
verification
(by echoing a challenge specified in the request) by the subscriber, the subscription is added for the topic at the
hub.</p>
</li>
<li>
<p>The publisher notifies the hub of updates to the topic and the content to deliver is identified.</p>
</li>
<li>
<p>The hub delivers the identified content to the subscribers of the topic.</p>
</li>
</ol>
<h3>Features</h3>
<h4>Subscriber</h4>
<p>This module allows introducing a WebSub Subscriber Service with <code>onIntentVerification</code>, which accepts HTTP GET requests for intent verification, and <code>onNotification</code>, which accepts HTTP POST requests for notifications. The WebSub Subscriber Service provides the following capabilities:</p>
<ul>
<li>When the service is started a subscription request is sent for a hub/topic combination, either specified as annotations or discovered based on the resource URL specified as an annotation.</li>
<li>If <code>onIntentVerification</code> is not specified, intent verification will be done automatically against the topic specified as an annotation or discovered based on the resource URL specified as an annotation.</li>
<li>If a secret is specified for the subscription, signature validation will be done for authenticated content distribution.</li>
</ul>
<h4>Hub</h4>
<p>A WebSub compliant hub based on the Ballerina Message Broker is also available. This can be used as a remote hub or to be used by publishers who want to have their own internal hub. Ballerina's WebSub hub honors specified lease periods and supports authenticated content distribution.</p>
<h5>Enabling Basic Auth support for the hub</h5>
<p>The Ballerina WebSub Hub can be secured by enforcing authentication (Basic Authentication) and optionally authorization.
<code>AuthProvider</code> and <code>authConfig</code> need to be specified for the hub listener and service respectively. If the
<code>authStoreProvider</code> of the <code>AuthProvider</code> is set as &quot;http:CONFIG_AUTH_STORE&quot;, usernames and passwords for authentication and scopes for authorization would be read from a config toml file.
A user can specify <code>AuthProvider</code> as follows and set it to the <code>hubListenerConfig</code> record passed when starting the hub.</p>
<pre><code class="language-ballerina">http:AuthProvider basicAuthProvider = {
    scheme: http:BASIC_AUTH,
    authStoreProvider: http:CONFIG_AUTH_STORE
};

http:ServiceEndpointConfiguration hubListenerConfig = {
    authProviders: [basicAuthProvider],
    secureSocket: {
        keyStore: {
            path: &quot;${ballerina.home}/bre/security/ballerinaKeystore.p12&quot;,
            password: &quot;ballerina&quot;
        }
    }
};

var val = websub:startHub(new http:Listener (9191, config =  hubListenerConfig));
</code></pre>
<p>In addition to the <code>AuthProvider</code> for listener, a user also has to specify the <code>authConfig</code> properties at service
config level.</p>
<p>It can be populated by providing <code>authConfig</code> via a toml formatted file under the <code>b7a.websub.hub.auth</code> alias.
Recognized users can also be mentioned in the same file which permits auth providers to read.</p>
<pre><code>[&quot;b7a.websub.hub.auth&quot;]
enabled=true  // enables the authentication
scopes=&quot;scope1&quot; // defines the scope of possible users

[&quot;b7a.users&quot;]

[&quot;b7a.users.tom&quot;]
password=&quot;1234&quot;
scopes=&quot;scope1&quot;
</code></pre>
<p>Once the hub is secured over basic auth, a subscriber should provide the relevant <code>auth</code> config in the
<code>subscriptionClientConfig</code> field of the subscriber service annotation.</p>
<pre><code class="language-ballerina">@websub:SubscriberServiceConfig {
    path: &quot;/ordereventsubscriber&quot;,
    subscriptionClientConfig: {
        auth: {
            scheme: http:BASIC_AUTH,
            username: &quot;tom&quot;,
            password: &quot;1234&quot;
        }
    }
}
</code></pre>
<h5>Enabling data persistence for the hub</h5>
<p>The Ballerina WebSub Hub supports persistence of topic and subscription data that needs to be restored when the hub is
restarted.</p>
<p>Users can introduce their own persistence implementation, by introducing an object type that is structurally
equivalent to the <code>websub:HubPersistenceStore</code> abstract object. Alternatively, the H2-based
<code>websub:H2HubPersistenceStore</code> object made available in the <code>ballerina/websub</code> module could be used to persist data.</p>
<p>Persistence can be enabled by setting a suitable <code>websub:HubPersistenceStore</code> value for the <code>hubPersistenceStore</code> field
in the <code>HubConfiguration</code> record, which is passed to the <code>websub:startHub()</code> function.</p>
<pre><code class="language-ballerina">import ballerina/h2;
import ballerina/http;
import ballerina/websub;

// Define an `h2:Client` to use with the `websub:H2HubPersistenceStore`.
h2:Client h2Client = new({
    path: &quot;./target/hubDB&quot;,
    name: &quot;hubdb&quot;,
    username: &quot;user1&quot;,
    password: &quot;pass1&quot;
});

// Define a `websub:H2HubPersistenceStore` as a `websub:HubPersistenceStore`.
websub:HubPersistenceStore hubPersistenceStore = new websub:H2HubPersistenceStore(h2Client);
// Set the defined persistence store as the `hubPersistenceStore` in the `hubConfig` record.
websub:HubConfiguration hubConfig = {
    hubPersistenceStore: hubPersistenceStore
};

// Pass the `hubConfig` record when starting up the hub to enable persistence.
var result = websub:startHub(new http:Listener(8080), hubConfiguration = hubConfig);
</code></pre>
<p>Any subscriptions added at the hub will now be available even when the hub is restarted.</p>
<h4>Publisher</h4>
<p>Ballerina WebSub publishers can use utility functions to add WebSub link headers indicating the hub and topic
URLs, which facilitates WebSub discovery.</p>
<p>A hub client endpoint is also made available to publishers and subscribers to perform the following:</p>
<ul>
<li>Publishers
<ul>
<li>Register a topic at the Hub</li>
<li>Publish to the hub indicating an update of the topic</li>
</ul>
</li>
<li>Subscribers
<ul>
<li>Subscribe/Unsubscribe to/from topics at a hub</li>
</ul>
</li>
</ul>
<h2>Samples</h2>
<p>This sample demonstrates a Subscriber Service with <code>subscribeOnStartUp</code> set to true. This will result in a
subscription request being sent to the specified hub for the specified topic, with the specified lease seconds value
and the specified secret for authenticated content distribution.
Since an <code>onIntentVerification</code> resource function is not included, intent verification for subscription and unsubscription
requests would happen automatically, if the topic specified in the request matches that specified as an annotation or
that discovered for the annotated resource URL.</p>
<pre><code class="language-ballerina">import ballerina/log;
import ballerina/websub;

listener websub:Listener websubEP = new(8181);

@websub:SubscriberServiceConfig {
    path: &quot;/websub&quot;,
    subscribeOnStartUp: true,
    topic: &quot;&lt;TOPIC_URL&gt;&quot;,
    hub: &quot;&lt;HUB_URL&gt;&quot;,
    leaseSeconds: 3600,
    secret: &quot;&lt;SECRET&gt;&quot;
}
service websubSubscriber on websubEP {

    resource function onNotification(websub:Notification notification) {
        var payload = notification.getTextPayload();
        if (payload is string) {
            log:printInfo(&quot;WebSub Notification Received: &quot; + payload);
        } else {
            log:printError(&quot;Error retrieving payload as string&quot;, err = payload);
        }
    }
}
</code></pre>
<p>Explicit intent verification can be done by introducing an <code>onIntentVerification</code> resource function.</p>
<pre><code class="language-ballerina">import ballerina/http;
import ballerina/log;
import ballerina/websub;

listener websub:Listener websubEP = new(8181);

@websub:SubscriberServiceConfig {
    path: &quot;/websub&quot;,
    subscribeOnStartUp: true,
    topic: &quot;&lt;TOPIC_URL&gt;&quot;,
    hub: &quot;&lt;HUB_URL&gt;&quot;,
    leaseSeconds: 3600,
    secret: &quot;&lt;SECRET&gt;&quot;
}
service websubSubscriber on websubEP {

    resource function onIntentVerification(websub:Caller caller, websub:IntentVerificationRequest request) {
        http:Response response = new;
        // Insert logic to build subscription/unsubscription intent verification response.
        var result = caller-&gt;respond(response);
        if (result is error) { 
            log:printError(&quot;Error responding to intent verification request&quot;, err = result); 
        }
    }

    resource function onNotification(websub:Notification notification) {
        var payload = notification.getTextPayload();
        if (payload is string) {
            log:printInfo(&quot;WebSub Notification Received: &quot; + payload);
        } else {
            log:printError(&quot;Error retrieving payload as string&quot;, err = payload);
        }
    }
}
</code></pre>
<p>Functions are made available on the <code>websub:IntentVerificationRequest</code> to build a subscription or unsubscription
verification response, specifying the topic to verify intent against:</p>
<pre><code class="language-ballerina">http:Response response = request.buildSubscriptionVerificationResponse(&quot;&lt;TOPIC_TO_VERIFY_FOR&gt;&quot;);
</code></pre>
<pre><code class="language-ballerina">http:Response response = request.buildUnsubscriptionVerificationResponse(&quot;&lt;TOPIC_TO_VERIFY_FOR&gt;&quot;);
</code></pre>
<p>Ballerina publishers can start up and publish directly to the Ballerina WebSub hub.</p>
<pre><code class="language-ballerina">import ballerina/log;
import ballerina/http;
import ballerina/runtime;
import ballerina/websub;

public function main() {

    log:printInfo(&quot;Starting up the Ballerina Hub Service&quot;);
    var result = websub:startHub(new http:Listener(9191));
    websub:WebSubHub webSubHub = result is websub:WebSubHub ? result : result.startedUpHub;

    var registrationResponse = webSubHub.registerTopic(&quot;&lt;TOPIC_URL&gt;&quot;);
    if (registrationResponse is error) {
        log:printError(&quot;Error occurred registering topic: &quot; + &lt;string&gt;registrationResponse.detail().message);
    } else {
        log:printInfo(&quot;Topic registration successful!&quot;);
    }

    // Make the publisher wait until the subscriber subscribes at the hub.
    runtime:sleep(20000);

    log:printInfo(&quot;Publishing update to internal Hub&quot;);
    var publishResponse = webSubHub.publishUpdate(&quot;&lt;TOPIC_URL&gt;&quot;, {&quot;action&quot;: &quot;publish&quot;, &quot;mode&quot;: &quot;internal-hub&quot;});
    if (publishResponse is error) {
        log:printError(&quot;Error notifying hub: &quot; + &lt;string&gt;publishResponse.detail().message);
    } else {
        log:printInfo(&quot;Update notification successful!&quot;);
    }

    // Make sure the service is running until the subscriber receives the update notification.
    runtime:sleep(5000);
}
</code></pre>
<p>Ballerina publishers can also use the hub client endpoint to register topics at Ballerina WebSub hubs
and publish/notify updates to the remote hubs.</p>
<pre><code class="language-ballerina">import ballerina/log;
import ballerina/runtime;
import ballerina/websub;

websub:Client websubHubClientEP = new(&quot;https://localhost:9191/websub/hub&quot;);

public function main() {

    var registrationResponse = websubHubClientEP-&gt;registerTopic(&quot;&lt;TOPIC_URL&gt;&quot;);
    if (registrationResponse is error) {
        log:printError(&quot;Error occurred registering topic: &quot; + &lt;string&gt;registrationResponse.detail().message);
    } else {
        log:printInfo(&quot;Topic registration successful!&quot;);
    }

    // Make the publisher wait until the subscriber subscribes at the hub.
    runtime:sleep(10000);

    log:printInfo(&quot;Publishing update to remote Hub&quot;);
    var publishResponse = websubHubClientEP-&gt;publishUpdate(&quot;&lt;TOPIC_URL&gt;&quot;, { &quot;action&quot;: &quot;publish&quot;, &quot;mode&quot;: &quot;remote-hub&quot; });
    if (publishResponse is error) {
        log:printError(&quot;Error notifying hub: &quot; + &lt;string&gt;publishResponse.detail().message);
    } else {
        log:printInfo(&quot;Update notification successful!&quot;);
    }

}
</code></pre>
<p>The hub client endpoint can also be used by subscribers to send subscription and unsubscription requests explicitly.</p>
<pre><code class="language-ballerina">import ballerina/log;
import ballerina/websub;

websub:Client websubHubClientEP = new(&quot;&lt;HUB_URL&gt;&quot;);

public function main() {

    // Send subscription request for a subscriber service.
    websub:SubscriptionChangeRequest subscriptionRequest = {
        topic: &quot;&lt;TOPIC_URL&gt;&quot;, 
        callback: &quot;&lt;CALLBACK_URL&gt;&quot;,
        secret: &quot;&lt;SECRET&gt;&quot;
    };

    var subscriptionChangeResponse = websubHubClientEP-&gt;subscribe(subscriptionRequest);
    if (subscriptionChangeResponse is websub:SubscriptionChangeResponse) {
        log:printInfo(&quot;Subscription Request successful at Hub [&quot; + subscriptionChangeResponse.hub 
                        + &quot;] for Topic [&quot; + subscriptionChangeResponse.topic + &quot;]&quot;);
    } else {
        log:printError(&quot;Error occurred with Subscription Request&quot;, err = subscriptionChangeResponse);
    }

    // Send unsubscription request for the subscriber service.
    websub:SubscriptionChangeRequest unsubscriptionRequest = {
        topic: &quot;&lt;TOPIC_URL&gt;&quot;,
        callback: &quot;&lt;CALLBACK_URL&gt;&quot;
    };

    subscriptionChangeResponse = websubHubClientEP-&gt;unsubscribe(unsubscriptionRequest);
    if (subscriptionChangeResponse is websub:SubscriptionChangeResponse) {
        log:printInfo(&quot;Unsubscription Request successful at Hub [&quot; + subscriptionChangeResponse.hub
                + &quot;] for Topic [&quot; + subscriptionChangeResponse.topic + &quot;]&quot;);
    } else {
        log:printError(&quot;Error occurred with Unsubscription Request&quot;, err = subscriptionChangeResponse);
    }
}
</code></pre>
<h2>Configuration Parameters</h2>
<p>The Ballerina WebSub implementation allows specifying the following properties/parameters via the Ballerina Config API,
where the values specified via the Config API would override values specified as params on hub start up.</p>
<table>
<thead>
<tr><th>Configuration Key</th><th>Default Value</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>b7a.websub.hub.leasetime</td><td>86400</td><td>The default lease period, if not specified in a request</td></tr>
<tr><td>b7a.websub.hub.signaturemethod</td><td>&quot;SHA256&quot;</td><td>The signature method to use for authenticated content distribution</td></tr>
<tr><td>b7a.websub.hub.remotepublish</td><td>false</td><td>Whether publishing updates against the topics in the hub could be done by remote publishers via HTTP requests with <code>hub.mode</code> set to <code>publish</code></td></tr>
<tr><td>b7a.websub.hub.topicregistration</td><td>true</td><td>Whether a topic needs to be registered at the hub for publishers to publish updates against the topic and for subscribers to send subscription requests for the topic</td></tr>
</tbody>
</table>
<h2>Introducing Specific Subscriber Services (Webhook Callback Services)</h2>
<p>Ballerina's WebSub subscriber service listener can be extended to introduce specific Webhooks.</p>
<p>Instead of the single <code>onNotification</code> resource, you can introduce multiple resources to accept content delivery requests using specific subscriber services. These resources will correspond to the content delivery requests that will
be delivered with respect to a particular topic.</p>
<p>For example, assume a scenario in which you receive notifications either when an issue is opened or when an issue is closed by subscribing to a particular topic in an issue tracking system. With a custom subscriber service listener, which extends the
generic WebSub subscriber service listener, you can allow two resources to accept content delivery requests (e.g., <code>onIssueOpened</code> and <code>onIssueClosed</code>) instead of the <code>onNotification</code> resource.</p>
<p>These resources will accept two parameters:</p>
<ol>
<li>The generic <code>websub:Notification</code> record as the first parameter</li>
<li>A custom record corresponding to the expected (JSON) payload of the notification (e.g., <code>IssueCreatedEvent</code>,
<code>IssueClosedEvent</code>)</li>
</ol>
<p>You can introduce a specific service as such by extending the generic subscriber service listener, specifying a
mapping between the expected notifications and the resources that requests need to be dispatched to.</p>
<p>The mapping can be based on one of the following indicators of a notification request.
(Requests will then be dispatched based on the value of the indicator in the request and a pre-defined mapping.)</p>
<ul>
<li>A request header</li>
<li>The payload: the value of a particular key in the JSON payload</li>
<li>A request header and the payload (combination of the above two)</li>
</ul>
<h4>Samples for Resource Mapping</h4>
<p><strong>Based on a request header</strong></p>
<p>Dispatching will be based on the value of the request header specified as <code>topicHeader</code>.</p>
<pre><code class="language-ballerina">websub:ExtensionConfig extensionConfig = {
    topicIdentifier: websub:TOPIC_ID_HEADER,
    topicHeader: &quot;&lt;HEADER_TO_CONSIDER&gt;&quot;,
    headerResourceMap: {
        &quot;issueOpened&quot;: (&quot;onIssueOpened&quot;, IssueOpenedEvent),
        &quot;issueClosed&quot;: (&quot;onIssueClosed&quot;, IssueClosedEvent)
    }
};
</code></pre>
<p>The <code>&quot;issueOpened&quot;: (&quot;onIssueOpened&quot;, IssueOpenedEvent)</code> entry indicates that when the value of the
<code>&lt;HEADER_TO_CONSIDER&gt;</code> header is <code>issueOpened</code>, dispatching should happen to a resource named <code>onIssueOpened</code>.</p>
<p>The first parameter of this resource will be the generic <code>websub:Notification</code> record, and the second parameter will
be a custom <code>IssueOpenedEvent</code> record mapping the JSON payload received when an issue is created.</p>
<p><strong>Based on the payload</strong></p>
<p>Dispatching will be based on the value in the request payload of one of the map keys specified in the
<code>payloadKeyResourceMap</code> map.</p>
<pre><code class="language-ballerina">websub:ExtensionConfig extensionConfig = {
    topicIdentifier: websub:TOPIC_ID_PAYLOAD_KEY,
    payloadKeyResourceMap: {
        &quot;&lt;PAYLOAD_KEY_TO_CONSIDER&gt;&quot;: {
            &quot;issueOpened&quot;: (&quot;onIssueOpened&quot;, IssueOpenedEvent),
            &quot;issueClosed&quot;: (&quot;onIssueClosed&quot;, IssueClosedEvent)
        }
    }
};
</code></pre>
<p>The <code>&quot;issueOpened&quot;: (&quot;onIssueOpened&quot;, IssueOpenedEvent)</code> entry indicates that when the value for the JSON payload
key <code>&lt;PAYLOAD_KEY_TO_CONSIDER&gt;</code> is <code>issueOpened</code>, dispatching should happen to a resource named <code>onIssueOpened</code>.</p>
<p>The first parameter of this resource will be the generic <code>websub:Notification</code> record, and the second parameter will
be a custom <code>IssueOpenedEvent</code> record, mapping the JSON payload received when an issue is created.</p>
<p><strong>Based on a request header and the payload</strong></p>
<p>Dispatching will be based on both a request header and the payload as specified in the <code>headerAndPayloadKeyResourceMap</code>.
Also, you can introduce a <code>headerResourceMap</code> and/or a <code>payloadKeyResourceMap</code> as additional mappings.</p>
<pre><code class="language-ballerina">websub:ExtensionConfig extensionConfig = {
    topicIdentifier: websub:TOPIC_ID_HEADER_AND_PAYLOAD,
    topicHeader: &quot;&lt;HEADER_TO_CONSIDER&gt;&quot;,
    headerAndPayloadKeyResourceMap: {
        &quot;issue&quot; : {
            &quot;&lt;PAYLOAD_KEY_TO_CONSIDER&gt;&quot; : {
                &quot;opened&quot;: (&quot;onIssueOpened&quot;, IssueOpenedEvent),
                &quot;closed&quot;: (&quot;onIssueClosed&quot;, IssueClosedEvent)
            }
        }
    }
};
</code></pre>
<p>The <code>&quot;opened&quot;: (&quot;onIssueOpened&quot;, IssueOpenedEvent)</code> entry indicates that when the value of the
<code>&lt;HEADER_TO_CONSIDER&gt;</code> header is <code>issue</code> and the value of the <code>&lt;PAYLOAD_KEY_TO_CONSIDER&gt;</code> JSON payload key is <code>opened</code>,
dispatching should happen to a resource named <code>onIssueOpened</code>.</p>
<p>The first parameter of this resource will be the generic <code>websub:Notification</code> record and the second parameter will
be a custom <code>IssueOpenedEvent</code> record, mapping the JSON payload received when an issue is created.</p>
<h4>Sample Specific Subscriber Service</h4>
<p>In order to introduce a specific subscriber service, a new Ballerina <code>listener</code> needs to be introduced. This <code>listener</code> should wrap the generic <code>ballerina/websub:Listener</code> and include the extension configuration described above.</p>
<p>The following example is for a service provider that</p>
<ul>
<li>allows registering webhooks to receive notifications when an issue is opened or assigned</li>
<li>includes a header named &quot;Event-Header&quot; in each content delivery request indicating what event the notification is
for (e.g., &quot;onIssueOpened&quot; when an issue is opened and &quot;onIssueAssigned&quot; when an issue is assigned)</li>
</ul>
<pre><code class="language-ballerina">import ballerina/websub;

// Introduce a record mapping the JSON payload received when an issue is opened.
public type IssueOpenedEvent record {
    int id;
    string title;
    string openedBy;
}; 

// Introduce a record mapping the JSON payload received when an issue is assigned.
public type IssueAssignedEvent record {
    int id;
    string assignedTo;
}; 

// Introduce a new `listener` wrapping the generic `ballerina/websub:Listener` 
public type WebhookListener object {

    *AbstractListener;

    private websub:Listener websubListener;

    public function __init(int port) {
        // Introduce the extension config, based on the mapping details.
        websub:ExtensionConfig extensionConfig = {
            topicIdentifier: websub:TOPIC_ID_HEADER,
            topicHeader: &quot;Event-Header&quot;,
            headerResourceMap: {
                &quot;issueOpened&quot;: (&quot;onIssueOpened&quot;, IssueOpenedEvent),
                &quot;issueAssigned&quot;: (&quot;onIssueAssigned&quot;, IssueAssignedEvent)
            }
        };
        
        // Set the extension config in the generic `websub:Listener` config.
        websub:SubscriberServiceEndpointConfiguration sseConfig = {
            extensionConfig: extensionConfig
        };
            
        // Initialize the wrapped generic listener.
        self.websubListener = new(port, config = sseConfig);
    }

    public function __attach(service s, string? name = ()) returns error?  {
        return self.websubListener.__attach(s, name = name);
    }

    public function __start() returns error? {
        return self.websubListener.__start();
    }
    
    public function __stop() returns error? {
        return self.websubListener.__stop();
    }
};
</code></pre>
<p>A service can now be introduced for the above service provider as follows.</p>
<pre><code class="language-ballerina">import ballerina/io;
import ballerina/log;
import ballerina/websub;

@websub:SubscriberServiceConfig {
    path: &quot;/subscriber&quot;,
    subscribeOnStartUp: false
}
service specificSubscriber on new WebhookListener(8080) {
    resource function onIssueOpened(websub:Notification notification, IssueOpenedEvent issueOpened) {
        log:printInfo(io:sprintf(&quot;Issue opened: ID: %s, Title: %s&quot;, issueOpened.id, issueOpened.title));
    }
    
    resource function onIssueAssigned(websub:Notification notification, IssueAssignedEvent issueAssigned) {
        log:printInfo(io:sprintf(&quot;Issue ID %s assigned to %s&quot;, issueAssigned.id, issueAssigned.assignedTo));
    }
}
</code></pre>
<p>For a step-by-step guide on introducing custom subscriber services, see the <a href="https://ballerina.io/learn/how-to-extend-ballerina/#create-webhook-callback-services">&quot;Create Webhook Callback Services&quot;</a> section of &quot;How to Extend Ballerina&quot;.</p>


            

            

            

            
           

            


            


            

            

            
        </div>
    </div>

<script>
    window.onload = (event) => {
        ballerinaHighlighter.highlightSnippets();
    };
</script>
</body>

<script>
    $(document)
    .ready(function() {

      // create sidebar and attach to menu open
      $('.ui.sidebar')
        .sidebar('attach events', '.toc.item')
      ;

    })
  ;

let mainNavLinks = document.querySelectorAll(".primary-list.module ul li a");
let mainSections = document.querySelectorAll(".main-wrapper section.method-content");

let lastId;
let cur = [];

let contentWrapper = document.querySelector(".content-wrapper");
contentWrapper.addEventListener("scroll", event => {
  let fromTop = contentWrapper.scrollTop;

  mainNavLinks.forEach(link => {
    let section = document.querySelector("#" + link.attributes.getNamedItem("data").textContent);

    if (
      section.offsetTop <= fromTop &&
      section.offsetTop + section.offsetHeight > fromTop
    ) {
      link.classList.add("current");
    } else {
      link.classList.remove("current");
    }
  });
});

</script>

